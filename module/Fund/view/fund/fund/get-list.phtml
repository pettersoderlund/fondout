<?php

$this->headScript()
     ->prependFile($this->basePath() . '/vendor/selectize/dist/js/standalone/selectize.min.js')
     ->prependFile($this->basePath() . '/vendor/chartjs/Chart.min.js')
     ->appendFile($this->basePath() . '/js/funds.js')
     ->appendFile($this->basePath() . '/js/sustainability-chart.js');


// set default order if not set and inverse the order based on the previous value
// $order = isset($query['order']) ? $query['order'] : 'ASC';
// $order = ($order == 'ASC') ? 'DESC' : 'ASC';
$order = 'ASC';

$form->setAttribute('method', 'GET');
$form->setAttribute('action', $this->url('funds', array(), array('query' => $query)));
$form->prepare();

$sform->setAttribute('method', 'POST');
$sform->setAttribute('action', $this->url('change-sustainability-categories'));
$sform->prepare();
$submit = $sform->get('submit');
$submit->setValue('Välj kategorier');

?>

<section class="jumbotron">
    <div class="container">
        <h1><?php echo $this->translate('Fondsök') ?></h1>
        <p>Bläddra bland över tusen svenska och internationella fonder.</p>
    </div>
</section>

<section class="sustainability-categories">
    <div class="container">
        <strong><?php echo $this->translate('Valda hållbarhetskategorier') ?></strong>
        <?php echo implode(', ', $sustainability) ?>
        <button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#sustainability-form"><?php echo $this->translate('Ändra') ?></button>

        <div id="sustainability-form" class="collapse">
            <?php echo $this->form()->openTag($sform) ?>
            <div class="checkbox">
                <?php
                    $this->formMultiCheckbox()->setSeparator('</div><div class="checkbox">');
                    echo $this->formMultiCheckbox($sform->get('sustainability'));
                ?>
            </div>
            <br />
            <?php echo $this->formSubmit($submit) ?>
            <?php echo $this->form()->closeTag() ?>
        </div>
    </div>
</section>

<section class="container">
    <div class="row">
        <div class="col-md-4 col-md-push-8">

            <?php echo $this->form()->openTag($form) ?>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><?php echo $this->translate('Sök på fond') ?></h3>

                </div>
                <div class="panel-body">
                    <p><?php echo $this->translate('Sök på hela eller delar av fondnamnet.') ?></p>
                    <div class="input-group">
                        <?php echo $this->formRow($form->get('q')); ?>
                        <span class="input-group-btn">
                            <?php echo $this->formSubmit($form->get('qSubmit')) ?>
                        </span>
                    </div><!-- /input-group -->
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><?php echo $this->translate('Fondkategori') ?></h3>
                </div>
                <div class="panel-body">
                    <p><?php echo $this->translate('Välj var i världen fonden äger sin majoritet av företag.') ?></p>
                    <div class="checkbox">
                        <?php
                            $this->formMultiCheckbox()->setSeparator('</div><div class="checkbox">');
                            echo $this->formMultiCheckbox($form->get('fondoutcategory'));
                        ?>
                    </div>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><?php echo $this->translate('Fondbolag') ?></h3>
                </div>
                <div class="panel-body">
                    <p><?php echo $this->translate(' Välj vilken bank eller fondbolags fonder du vill se.') ?></p>
                    <?php echo $this->formSelect($form->get('company')) ?>
                </div>
            </div>

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title"><?php echo $this->translate('Fondstorlek') ?></h3>
                </div>
                <div class="panel-body">
                    <p><?php echo $this->translate('Välj vilken storlek av fonder du vill se. Fonder som många personer äger är generellt större och nischade fonder mindre. ') ?></p>
                    <div class="checkbox">
                        <?php
                            $this->formMultiCheckbox()->setSeparator('</div><div class="checkbox">');
                            echo $this->formMultiCheckbox($form->get('size'));
                        ?>
                    </div>
                </div>
            </div>

            <?php echo $this->formHidden($form->get('category')) ?>
            <?php echo $this->formSubmit($form->get('submit')) ?>
            <?php echo $this->form()->closeTag() ?>
            <br />
        </div>
        <div class="col-md-8 col-md-pull-4">

            <?php if (count($funds)): ?>
            <table class="table table-bordered table-hover">
                    <tr>
                        <th>
                            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'name', 'order' => $order) + $query))); ?>">
                                <?php echo $this->translate('Fond') ?>
                            </a>
                        </th>
                        <!--<th>
                            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'company', 'order' => $order) + $query))); ?>">
                                <?php echo $this->translate('Fondbolag') ?>
                            </a>
                        </th>
                        <th>
                            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'fondoutcategory', 'order' => $order) + $query))); ?>">
                                <?php echo $this->translate('Fondkategori') ?>
                            </a>
                        </th>
                        <th>
                            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'size', 'order' => $order)  + $query))); ?>">
                                <?php echo $this->translate('Storlek') ?>
                            </a>
                        </th>
                        <th>
                            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'co2Coverage', 'order' => $order)  + $query))); ?>">
                                <?php echo $this->translate('CO2-täckning') ?>
                            </a>
                        </th> -->
                        <th>
                            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'co2', 'order' => $order)  + $query))); ?>">
                                <?php echo $this->translate('CO2/kr') ?>
                            </a>
                        </th>
                        <th>
                            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'sustainability', 'order' => 'DESC')  + $query))); ?>">
                                <?php echo $this->translate('Hållbarhetspoäng') ?>
                            </a>
                        </th>
                    </tr>
            </table>

            <ul class="results">
            <?php foreach ($funds as $fund): ?>
              <li>
                <div class="chart-container pull-right" style="width:100px;height:100px;">
                  <canvas class="sustainability-chart" data-percentage="<?php echo $fund->getSustainability() ?>"></canvas>
                  <div class="sustainability-percentage">
                    <?php
                    echo $this->numberFormat(
                      $fund->getSustainability(),
                      NumberFormatter::PERCENT,
                      NumberFormatter::TYPE_DEFAULT,
                      "en_US"
                      );
                      ?>
                  </div>

                </div>
                <div class="pull-right"><h1>
                <?php
                    if ($fund->co2Coverage>0.5):
                        echo number_format($fund->co2, 2, ',', ' ');

                    ?></h1> <br>gram CO2/kr
                <?php endif;?>
            </div>
                <h3>
                  <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array('id' => $fund->id))) ?>" title="">
                    <?php echo $this->translate($fund->name) ?>
                  </a>
                </h3>

                <p><?php echo $this->translate($fund->company->name) ?></p>
                <p>
                <span class="label label-primary"><?php echo $this->translate($fund->fondoutcategory->title) ?></span>
                <span class="label label-primary"><?php
                    if ($fund->totalMarketValue <= 600000000) {
                        echo $this->translate('Liten');
                    } elseif ($fund->totalMarketValue >= 2500000000) {
                        echo $this->translate('Stor');
                    } else {
                        echo $this->translate('Mellan');
                    }
                ?></span>
                </p>


              </li>
            <?php endforeach; ?>
            </ul>
            <?php else: ?>
            <h3><?php echo $this->translate('Vi kunde inte hitta några resultat med dina söktermer.') ?></h3>
            <br>
            <h4><?php echo $this->translate('Förslag') ?>:</h4>
            <ul>
              <li><?php echo $this->translate('Dubbelkolla din stavning') ?></li>
              <li><?php echo $this->translate('Använd mer generalla söktermer') ?></li>
            </ul>
            <?php endif; ?>

            <?php if ($funds->getPages()->pageCount > 1): ?>
                <ul class="pagination pagination-centered">
                    <!-- Previous page link -->
                    <?php if (isset($funds->getPages()->previous)): ?>
                        <li>
                            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('page' => $funds->getPages()->previous) + $query))); ?>">
                                &laquo;
                            </a>
                        </li>
                        <?php
                        else: ?>
                        <li class="disabled">
                            <a href="#">
                                &laquo;
                            </a>
                        </li>
                    <?php endif; ?>
                    <!-- Numbered page links -->
                    <?php foreach ($funds->getPages()->pagesInRange as $page): ?>
                        <?php if ($page != $funds->getPages()->current): ?>
                            <li>
                                <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('page' => $page)  + $query))); ?>">
                                    <?php echo $page; ?>
                                </a>
                            </li>
                        <?php else: ?>
                            <li class="active">
                                <a href="#"><?php echo $page; ?></a>
                            </li>
                        <?php endif; ?>
                    <?php endforeach; ?>

                    <!-- Next page link -->
                    <?php if (isset($funds->getPages()->next)): ?>
                        <li>
                            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('page' => $funds->getPages()->next) + $query))); ?>">
                                &raquo;
                            </a>
                        </li>
                    <?php else: ?>
                        <li class="disabled">
                            <a href="#">
                                &raquo;
                            </a>
                        </li>
                    <?php endif; ?>
                </ul>
            <?php endif; ?>
        </div>
</section>
