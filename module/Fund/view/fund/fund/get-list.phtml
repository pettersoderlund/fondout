<?php

$this->headScript()
->prependFile($this->basePath() . '/vendor/selectize/dist/js/standalone/selectize.min.js')
->appendFile($this->basePath() . '/js/funds.js');

if (isset($query['order'])) {
  $order = $query['order'];
} else {
  $order = 'ASC';
}

if ($order == 'ASC') {
  $reverseorder = 'DESC';
} else {
  $reverseorder = 'ASC';
}

if (isset($query['sort'])) {
  $sortby = $query['sort'];
} else {
  $sortby = "name";
}


/* Filter funds form */
$form->setAttribute('method', 'GET');
$form->setAttribute('action', $this->url('funds', array(), array('query' => $query)));
$form->prepare();
?>
<section class="fund-search-intro">
  <div class="container">
    <div class="intro-section">
      <h2 class="centered-header">Så här enkelt är det</h2>
      <div class="row">
        <div class="col-md-2 col-md-offset-1">
          <h4>1. Välj vad du vill se</h4>
          <p><strong>Fondkategori</strong> - Välj var i världen/ inom vilken bransch fonden
            primärt investerar. Det går även att välja flera fondkategorier
            samtidigt.
          </p>
          <p><strong>Dina fonder</strong> -
            Lägg till de fonder du har idag eller de fonder du är intresserad
            av.
          </p>
          <p><strong>Fondbolag</strong> -
            Visa endast fonder från ett specifikt fondbolag.
          </p>
          <p><strong>Snabbsök</strong> -
            Gör en snabbsökning efter en specifik fond.
          </p>

        </div>
        <div class="col-md-2">
          <h4>2. Välj hur du vill ranka</h4>
          <p>Du kan ranka fonderna efter följande mått:</p>
          <ul class="sort-by-explainations">
            <li>
              <img class="roundintrosymbols" src="/img/symbols/fossil.png" alt="Fossil symbol">
              Fossila bränslen
            </li>
            <li>
              <img class="roundintrosymbols" src="/img/symbols/weapon.png" alt="Weapon symbol">
              Förbjudna Vapen
            </li>
            <li>
              <img class="sqintrosymbols" src="/img/symbols/alcohol.png" alt="Alcohol symbol">
              Alkohol
            </li>
            <li>
              <img class="sqintrosymbols" src="/img/symbols/tobacco.png" alt="Tobacco symbol">
              Tobak
            </li>
            <li>
              <img class="sqintrosymbols" src="/img/symbols/gambling.png" alt="Gambling symbol">
              Spel
            </li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>3. Se resultat & jämför</h4>
          <p>Låt oss säga att du valt att ranka efter <span class="red">fossila bränslen</span>. De fonder som visas högst upp i listan är de fonder som investerat i minst antal bolag med <span class="red">fossila bränslen</span>.  </p>
          <p>För en bättre överblick visas även fondens resultat för de övriga måtten. Du kan när som helst välja att ranka efter ett nytt mått.</p>
          <div class="row bars-explained">
            <div class="col-md-4">
              <div class="centered-column">
                <img id="introBar" src="/img/bar/bar10.png" alt="10/10 mätare.">
              </div>
              <p><small>Inga/väldigt få bolag med <span class="red">fossila bränslen</span> i fonden. </small></p>
            </div>
            <div class="col-md-4">
              <div class="centered-column">
                <img id="introBar" src="/img/bar/bar7.png" alt="7/10 mätare.">
              </div>
              <p><small>Ganska många bolag med <span class="red">fossila bränslen</span> i fonden. </small></p>
            </div>
            <div class="col-md-4">
              <div class="centered-column">
                <img id="introBar" src="/img/bar/bar3.png" alt="3/10 mätare.">
              </div>
              <p><small>Väldigt många bolag med <span class="red">fossila bränslen</span> i fonden.</small></p>
            </div>
          </div>

        </div>
        <div class="col-md-2">
          <h4>4. Fördjupa dig</h4>
          <p>Genom att klicka på en fond kommer du till fondens fördjupningssida. </p>
          <p>Här hittar du mer information om våra mått, hur fondens investeringar står sig i relation till dess fondkategori och övriga fonder. Du hittar även mer information om fonden och fondbolaget. </p>
          <span class="label label-primary">Fonden är bättre än snittet för fondkategorin. </span>
          <span class="label label-primary">Fonden är bättre än snittet för alla fonder. </span>
        </div>
        <div class="col-md-2">
          <h4>5. Välj fonder</h4>
          <p>Grattis! Nu har du kunskapen för att kunna föra ett medvetet fondval som ligger i linje med dina hållbarhetspreferenser. </p>
          <p><strong>Vilken eller vilka fonder du väljer är så klart helt upp till dig.</strong> </p>
        </div>
      </div>
    </div>
  </div>
</section>
<nav class="sort-menu">
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <div class="row">
          <div class="col-md-4">
          <p id="fund-header">Fond</p>
          <p id="sort-header"><small>Ranka efter</small></p>
          </div>
          <div class="col-md-1 centered-column">
            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('fragment' => 'fund-section', 'query' => array('sort' => 'fossil', 'order' => ($sortby == 'fossil' ? $reverseorder : 'ASC'))  + $query))); ?>">
              <img class="sort-button" src="/img/<?php echo ($sortby == 'fossil') ? "symbols/" : "gray-symbols/"?>fossil.png" alt="Fossil sort button">
            </a>
          </div>
          <div class="col-md-1 centered-column">
            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('fragment' => 'fund-section', 'query' => array('sort' => 'weapon', 'order' => ($sortby == 'weapon' ? $reverseorder : 'ASC'))  + $query))); ?>">
              <img class="sort-button" src="/img/<?php echo ($sortby == 'weapon') ? "symbols/" : "gray-symbols/"?>weapon.png" alt="Weapon sort button">
            </a>
          </div>
          <div class="col-md-2 centered-column">
            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('fragment' => 'fund-section', 'query' => array('sort' => 'alcohol', 'order' => ($sortby == 'alcohol' ? $reverseorder : 'ASC'))  + $query))); ?>">
              <img class="sort-button" src="/img/<?php echo ($sortby == 'alcohol') ? "symbols/" : "gray-symbols/"?>alcohol.png" alt="Alcohol sort button">
            </a>
            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('fragment' => 'fund-section', 'query' => array('sort' => 'tobacco', 'order' => ($sortby == 'tobacco' ? $reverseorder : 'ASC'))  + $query))); ?>">
              <img class="sort-button" src="/img/<?php echo ($sortby == 'tobacco') ? "symbols/" : "gray-symbols/"?>tobacco.png" alt="Tobacco sort button">
            </a>
            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('fragment' => 'fund-section', 'query' => array('sort' => 'gambling', 'order' => ($sortby == 'gambling' ? $reverseorder : 'ASC'))  + $query))); ?>">
              <img class="sort-button" src="/img/<?php echo ($sortby == 'gambling') ? "symbols/" : "gray-symbols/"?>gambling.png" alt="Gamlbing sort button">
            </a>

          </div>
          <div class="col-md-4 centered-column">
            <p>Fondinformation</p>
          </div>
          <!--<button class="btn"><a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'name', 'order' => ($sortby == 'name' ? $reverseorder : 'ASC'))  + $query))); ?>">A-Z</a></button>-->
        </div>
      </div>
      <div class="col-md-3 centered-column">
        <p>Sökalternativ</p>
      </div>
    </div>
  </div>
</nav>

  <section id="fund-section" class="container fund-list content">
    <div class="row">
      <div id="fund-filters" class="col-md-3 col-md-push-9 panel-group panel-box clearfix">
        <div class="filter-header">
          <h3>Begränsa sökresultaten: </h3>
          <p><?php echo $funds->getPages()->totalItemCount;?> fonder.</p>
        </div>
        <?php echo $this->form()->openTag($form) ?>


        <div class="panel panel-default">
          <div class="panel-heading">
            <h3 class="panel-title">
              <a data-toggle="collapse" data-parent="#accordion" href="#collapseFondoutCategory">
                <?php echo $this->translate('Fondkategori') ?>
              </a>
            </h3>
          </div>

          <div id="collapseFondoutCategory" class="panel-collapse collapse in"><!--class="panel-collapse collapse <?php if ($form->get('fondoutcategory')->getValue()) {echo " in ";} ?>">-->
            <div class="panel-body">
              <p><?php echo $this->translate('Välj var i världen fonden äger sin majoritet av företag.') ?></p>
              <div class="checkbox">
                <?php
                $this->formMultiCheckbox()->setSeparator('</div><div class="checkbox">');
                  echo $this->formMultiCheckbox($form->get('fondoutcategory'));
                  ?>
                </div>
                <div class="search-fund-button pull-right">
                  <?php echo $this->formSubmit($form->get('submit')->setValue('Uppdatera fondsökning')) ?>
                </div>
              </div>
            </div>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseFund">
                  <?php echo $this->translate('Jämför mina fonder') ?>
                </a>
              </h3>
            </div>
            <div id="collapseFund" class="panel-collapse collapse <?php if ($form->get('fund')->getValue()) {echo " in ";} ?>">
              <div class="panel-body">
                <p><?php echo $this->translate('Välj vilka fonder du vill se.') ?></p>
                <?php echo $this->formSelect($form->get('fund')) ?>
                <div class="search-fund-button pull-right">
                  <?php echo $this->formSubmit($form->get('submit')->setValue('Jämför mina fonder')) ?>
                </div>
              </div>

            </div>
          </div>

          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseCompany">
                  <?php echo $this->translate('Fondbolag') ?>
                </a>
              </h3>
            </div>
            <div id="collapseCompany" class="panel-collapse collapse <?php if ($form->get('company')->getValue()) {echo " in ";} ?>">
              <div class="panel-body">
                <p><?php echo $this->translate(' Välj vilken bank eller fondbolags fonder du vill se.') ?></p>
                <?php echo $this->formSelect($form->get('company')) ?>
                <div class="search-fund-button pull-right">
                  <?php echo $this->formSubmit($form->get('submit')->setValue('Uppdatera fondsökning')) ?>
                </div>
              </div>

            </div>
          </div>



          <div class="panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseQ">
                  <?php echo $this->translate('Snabbsök') ?>
                </a>
              </h3>
            </div>

            <div id="collapseQ" class="panel-collapse collapse <?php if ($form->get('q')->getValue()) {echo " in ";}?>">
              <div class="panel-body">
                <p><?php echo $this->translate('Sök på hela eller delar av fondnamnet.') ?></p>
                <div class="input-group">
                  <?php echo $this->formRow($form->get('q')); ?>
                </div><!-- /input-group -->
                <div class="search-fund-button pull-right">
                  <?php echo $this->formSubmit($form->get('submit')->setValue('Sök fonder')) ?>
                </div>
              </div>
            </div>
          </div>

          <?php echo $this->formHidden($form->get('category')) ?>
            <?php echo $this->form()->closeTag() ?>
            <br />
          </div>
          <div class="col-md-9 col-md-pull-3">
            <?php if (count($funds)): ?>

<ul class="results">
  <?php foreach ($funds as $fund): ?>
    <li>
      <div class="row">
        <div class="col-md-4">
          <?php echo  ($fund->fundCompany->premium) ? "<img class='fund-logo' src='/img/fund-company/logo/" . $fund->fundCompany->id . ".jpg' alt='" . $fund->fundCompany->name . " logo'>" : "" ?>
          <h3>
            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array('id' => $fund->url))) ?>" title="" target="_blank">
              <?php echo $this->translate($fund->name) ?>
            </a>
          </h3>
        </div>
        <div class="col-md-1 centered-column">
          <?php echo "<img class='bar' data-toggle='tooltip' title='Snitt urvalet fossil: " . $avgfund->getMeasureScore('fossil') .  "/10' src='img/bar/bar" . $fund->getMeasureScore('fossil') . ".png'>"    ?>
          <img class="round-symbol" src="/img/symbols/fossil.png">
        </div>
        <div class="col-md-1 centered-column">
          <?php echo "<img class='bar' data-toggle='tooltip' title='Snitt urvalet vapen: " . $avgfund->getMeasureScore('weapon') .  "/10' src='img/bar/bar" . $fund->getMeasureScore('weapon') . ".png'>"    ?>
          <img class="round-symbol" src="/img/symbols/weapon.png">
        </div>
        <div class="col-md-2 centered-column">
          <?php echo "<img class='thin-bar' data-toggle='tooltip' title='Snitt urvalet alkohol: " . $avgfund->getMeasureScore('alcohol') .  "/10' src='img/thin-bar/thinbar" . $fund->getMeasureScore('alcohol') . ".png'>" ?>
          <?php echo "<img class='thin-bar' data-toggle='tooltip' title='Snitt urvalet tobak: " . $avgfund->getMeasureScore('tobacco') .  "/10' src='img/thin-bar/thinbar" . $fund->getMeasureScore('tobacco') . ".png'>"   ?>
          <?php echo "<img class='thin-bar' data-toggle='tooltip' title='Snitt urvalet spel: " . $avgfund->getMeasureScore('gambling') .  "/10' src='img/thin-bar/thinbar" . $fund->getMeasureScore('gambling'). ".png'>"   ?>
          <br>
          <img class="thin-symbol" src="/img/symbols/alcohol.png">
          <img class="thin-symbol" src="/img/symbols/tobacco.png">
          <img class="thin-symbol" src="/img/symbols/gambling.png">
        </div>
        <div class="col-md-4 centered-column">
          <a class="fundinfo-btn btn btn-xs" href="/fundcompany/<?php echo $this->translate($fund->company->url) ?>">
              <?php echo $this->translate($fund->company->name) ?>
          </a>

          <a class="fundinfo-btn btn btn-xs" href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('fondoutcategory[]' => $fund->fondoutcategory->id)))); ?>">
            <?php echo $this->translate($fund->fondoutcategory->longName) ?>
          </a>
          <?php echo (in_array('Nordnet', $fund->getBankArray())) ? "<p class='bank-availible'>Fonden finns att köpa på <img src='/img/nordnet.jpg' alt='Nordnet logo' class='bank-logo'></p>" : "" ?>


        </div>
      </div>
    </li>
  <?php endforeach; ?>
</ul>

<?php else: ?>
  <h3>
    <?php echo $this->translate(
      'Vi kunde inte hitta några resultat med dina söktermer.') ?>
  </h3>
  <br>
  <h4><?php echo $this->translate('Förslag') ?>:</h4>
  <ul>
    <li><?php echo $this->translate('Dubbelkolla din stavning') ?>        </li>
    <li><?php echo $this->translate('Använd mer generella söktermer') ?>  </li>
    <li><a href="/funds" class="btn btn-primary" role="button">
      Återställ sökning
    </a></li>
  </ul>

<?php endif; ?>

<?php if ($funds->getPages()->pageCount > 1): ?>
  <ul class="pagination pagination-centered">
    <!-- Previous page link -->
    <?php if (isset($funds->getPages()->previous)): ?>
      <li>
        <a href="<?php echo $this->escapeHtmlAttr(
        $this->url(
        'funds',
        array(),
        array('query' => array('page' => $funds->getPages()->previous) + $query
        ))); ?>">
          &laquo;
        </a>
      </li>
      <?php
      else: ?>
      <li class="disabled">
        <a href="#">
          &laquo;
        </a>
      </li>
    <?php endif; ?>
    <!-- Numbered page links -->
    <?php foreach ($funds->getPages()->pagesInRange as $page): ?>
      <?php if ($page != $funds->getPages()->current): ?>
        <li>
          <a href="<?php echo $this->escapeHtmlAttr(
            $this->url(
              'funds',
              array(),
              array('query' => array('page' => $page)  + $query
            )
          )); ?>">
            <?php echo $page; ?>
          </a>
        </li>
      <?php else: ?>
        <li class="active">
          <a href="#"><?php echo $page; ?></a>
        </li>
      <?php endif; ?>
    <?php endforeach; ?>

    <!-- Next page link -->
    <?php if (isset($funds->getPages()->next)): ?>
      <li>
        <a href="<?php echo $this->escapeHtmlAttr(
        $this->url(
        'funds',
        array(),
        array('query' => array('page' => $funds->getPages()->next) + $query
        ))); ?>">
          &raquo;
        </a>
      </li>
    <?php else: ?>
      <li class="disabled">
        <a href="#">
          &raquo;
        </a>
      </li>
    <?php endif; ?>
  </ul>
<?php endif; ?>
</div>
</section>
