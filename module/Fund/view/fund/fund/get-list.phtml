<?php
$this->headScript()
->prependFile($this->basePath() . '/vendor/selectize/dist/js/standalone/selectize.min.js')
->appendFile($this->basePath() . '/js/funds.js');
$this->headTitle("Fondsök", 'PREPEND');

$this->headMeta()->appendName('description',  $this->translate('Fondsök är ett verktyg för att sortera aktiefonder efter hur de investerar i känsliga branscher som tobak, vapen, fossila bränslen, alkohol och spelbolag. '));

if (isset($query['order'])) {
  $order = $query['order'];
} else {
  $order = 'ASC';
}

if ($order == 'ASC') {
  $reverseorder = 'DESC';
} else {
  $reverseorder = 'ASC';
}

if (isset($query['sort'])) {
  $sortby = $query['sort'];
} else {
  $sortby = "name";
}

/* Filter funds form */
$form->setAttribute('method', 'GET');
$form->setAttribute('action', $this->url('funds', array(), array('query' => $query)));
$form->prepare();
?>

<div class="centered-column">
  <a class="accordion-toggle" data-toggle="collapse" data-parent="#fund-type-accordion" href="#fund-type-selector-options">
      <h2 class="fund-category-top-display"><?php echo current($funds->getItemsByPage(1))->fondoutcategory->longName ?>er<span class="glyphicon glyphicon-option-vertical"></span></h2>
  </a>

  <div class="accordion" id="fund-type-accordion">
    <div class="accordion-group">

      <div id="fund-type-selector-options" class="accordion-body collapse">
        <div class="accordion-inner">
          <?php $fund_categories = array('5'=>'Sverige', '6' => 'Global'); ?>
          <div class="row">
            <?php foreach ($fund_categories as $fc_index => $categoryName): ?>
              <a class="btn btn-info" 
              href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('fondoutcategory[]' => $fc_index)))) ?> " >
                <?php echo $categoryName; ?>
              </a>
            <?php endforeach; ?>
          </div>


        </div>
      </div>
    </div>
  </div>

</div>


<nav class="sort-menu">
  <div class="container">
    <div class="row">
          <div class="">
            <div class="col-xs-4 left">
              <a class="btn btn-default btn-sm" href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'fee', 'order' => ($sortby == 'fee' ? $reverseorder : 'ASC'))  + $query))); ?>">
                  Avgift <span class="glyphicon glyphicon-sort"></span>
              </a>
            </div>
            <div class="col-xs-3 middle">
              <a class="btn btn-default btn-sm" href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'nav1year', 'order' => ($sortby == 'nav1year' ? $reverseorder : 'ASC'))  + $query))); ?>">
                  1 år <span class="glyphicon glyphicon-sort"></span>
              </a>
            </div>
            <!-- <a class="btn btn-default" href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'nav3year', 'order' => ($sortby == 'nav3year' ? $reverseorder : 'ASC'))  + $query))); ?>">
                3 år <span class="glyphicon glyphicon-sort"></span>
            </a> -->
            <!-- <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'fossil', 'order' => ($sortby == 'fossil' ? $reverseorder : 'ASC'))  + $query))); ?>">
              <img class="sort-button" data-toggle='tooltip' data-placement='bottom' title='Sortera efter fossila bränsen' src="/img/<?php echo ($sortby == 'fossil') ? "symbols/" : "gray-symbols/"?>fossil.png" alt="Fossil sort button">
            </a>
            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'weapon', 'order' => ($sortby == 'weapon' ? $reverseorder : 'ASC'))  + $query))); ?>">
              <img class="sort-button" data-toggle='tooltip' data-placement='bottom' title='Sortera efter förbjudna vapen' src="/img/<?php echo ($sortby == 'weapon') ? "symbols/" : "gray-symbols/"?>weapon.png" alt="Weapon sort button">
            </a>
            <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'tobacco', 'order' => ($sortby == 'tobacco' ? $reverseorder : 'ASC'))  + $query))); ?>">
              <img class="sort-button" data-toggle='tooltip' data-placement='bottom' title='Sortera efter tobak' src="/img/<?php echo ($sortby == 'tobacco') ? "symbols/" : "gray-symbols/"?>tobacco.png" alt="Tobacco sort button">
            </a>
          </div> -->
            <div class="col-xs-5 right">
              <a class="btn btn-default btn-sm" href="<?php echo $this->escapeHtmlAttr($this->url('funds', array(), array('query' => array('sort' => 'shp', 'order' => ($sortby == 'shp' ? $reverseorder : 'ASC'))  + $query))); ?>">
                  Hållbarhetsp. <span class="glyphicon glyphicon-sort"></span>
              </a>
            </div>
          </div>

    </div>
  </div>
</nav>

<section id="fund-section" class="container fund-list content">
  <div class="row">
  <div class="col-xs-12">
      <?php if (count($funds)): ?>
        <ul class="results">
          <?php foreach ($funds as $fund): ?>
            <li>
              <div class="row">
                <div class="col-xs-10">
                  <h3>
                    <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array('id' => $fund->url))) ?>" title="" target="_blank">
                      <?php echo $this->translate($fund->name) ?>
                    </a>
                  </h3>
                  <div class="col-xs-6">
                    <span class="<?php echo $sortby == 'fee' ? 'sort-by' : '' ?>">
                        <?php echo ($sortby != 'fee' && $fund->annualFee == 0) ? "-" : number_format($fund->annualFee, 2) . '%'  ?>
                      </span>
                  </div>
                  <div class="col-xs-6">
                    <span class="<?php echo $sortby == 'nav1year' ? 'sort-by' : '' ?>">
                        <?php echo ($fund->nav1year != 0) ? number_format($fund->nav1year, 0) . '%' : "-" ?>
                      </span>
                  </div>
                  <!-- <?php echo ($fund->nav3year != 0) ? number_format($fund->nav3year, 0) . '%' : "-" ?> -->
                </div>
                <div class="col-xs-2 shp-number-score-container">
                  <h3>
                    <span class="shp-number-score <?php echo $sortby == 'shp' ? 'sort-by' : '' ?> <?php echo $fund->getMeasureScore('shp') > 8 ? 'green' : ($fund->getMeasureScore('shp') > 4 ? 'yellow' : 'red')  ?>"><?php echo $fund->getMeasureScore('shp') ?></span>
                  </h3>
                </div>





                  <div class="col-sm-5 centered-column hidden">
                    <div class="shp-categories-box">
                      <h6>Hållbarhetspoäng uppdelat</h6>
                      <?php echo "<img class='bar' src='img/bar/bar" . $fund->getMeasureScore('fossil') . ".png' alt='Fossila bränslen " . $fund->getMeasureScore('fossil') . "/10'>"    ?>
                      <?php echo "<img class='bar' src='img/bar/bar" . $fund->getMeasureScore('weapon') . ".png' alt='Vapen " . $fund->getMeasureScore('weapon') . "/10'>"    ?>
                      <?php echo "<img class='bar' src='img/bar/bar" . $fund->getMeasureScore('tobacco') . ".png' alt='Tobak " . $fund->getMeasureScore('tobacco') . "/10'>"   ?>
                      <br>
                      <img class="round-symbol" src="/img/<?php echo ($sortby == 'fossil') ? "symbols/" : "gray-symbols/"?>fossil.png" alt='Fossila bränslen symbol'>
                      <img class="round-symbol" src="/img/<?php echo ($sortby == 'weapon') ? "symbols/" : "gray-symbols/"?>weapon.png" alt='Vapen symbol'>
                      <img class="round-symbol" src="/img/<?php echo ($sortby == 'tobacco') ? "symbols/" : "gray-symbols/"?>tobacco.png" alt='Tobak symbol'>

                    </div>
                  </div>

                </div>
            </li>
          <?php endforeach; ?>
        </ul>

      <?php else: ?>
        <h3>
          <?php echo $this->translate(
            'Vi kunde inte hitta några resultat med dina söktermer.') ?>
        </h3>
        <br>
        <h4><?php echo $this->translate('Förslag') ?>:</h4>
        <ul>
          <li><?php echo $this->translate('Dubbelkolla din stavning') ?>        </li>
          <li><?php echo $this->translate('Använd mer generella söktermer') ?>  </li>
          <li><a href="/funds" class="btn btn-primary" role="button">
            Återställ sökning
          </a></li>
        </ul>

      <?php endif; ?>

      <?php if ($funds->getPages()->pageCount > 1): ?>
        <ul class="pagination pagination-centered">
          <!-- Previous page link -->
          <?php if (isset($funds->getPages()->previous)): ?>
            <li>
              <a href="<?php echo $this->escapeHtmlAttr(
              $this->url(
              'funds',
              array(),
              array('query' => array('page' => $funds->getPages()->previous) + $query
              ))); ?>">
                &laquo;
              </a>
            </li>
            <?php
            else: ?>
            <li class="disabled">
              <a href="#">
                &laquo;
              </a>
            </li>
          <?php endif; ?>
          <!-- Numbered page links -->
          <?php foreach ($funds->getPages()->pagesInRange as $page): ?>
            <?php if ($page != $funds->getPages()->current): ?>
              <li>
                <a href="<?php echo $this->escapeHtmlAttr(
                  $this->url(
                    'funds',
                    array(),
                    array('query' => array('page' => $page)  + $query
                  )
                )); ?>">
                  <?php echo $page; ?>
                </a>
              </li>
            <?php else: ?>
              <li class="active">
                <a href="#"><?php echo $page; ?></a>
              </li>
            <?php endif; ?>
          <?php endforeach; ?>

          <!-- Next page link -->
          <?php if (isset($funds->getPages()->next)): ?>
            <li>
              <a href="<?php echo $this->escapeHtmlAttr(
              $this->url(
              'funds',
              array(),
              array('query' => array('page' => $funds->getPages()->next) + $query
              ))); ?>">
                &raquo;
              </a>
            </li>
          <?php else: ?>
            <li class="disabled">
              <a href="#">
                &raquo;
              </a>
            </li>
          <?php endif; ?>
        </ul>
      <?php endif; ?>
    </div>
  </div>
</section>
