<?php

$this->headScript()
->prependFile($this->basePath() . '/vendor/selectize/dist/js/standalone/selectize.min.js')
->prependFile($this->basePath() . '/vendor/chartjs/Chart.min.js')
->appendFile($this->basePath() . '/js/fundprofile.js')
->appendFile($this->basePath() . '/js/sustainability-chart.js');

$sform->setAttribute('method', 'POST');
$sform->setAttribute('action', $this->url('change-sustainability-categories'));
$sform->prepare();
$submit = $sform->get('submit');
$submit->setValue('Välj kategorier');
?>

<section class="jumbotron">
  <div class="container">
    <h1><?php echo $this->escapeHtml($fund->name) ?></h1>
  </div>
</section>

<section class="sustainability-categories">
  <div class="container">
    <strong><?php echo $this->translate('Valda hållbarhetskategorier') ?></strong>
    <?php echo implode(', ', $sustainability) ?>
    <button type="button" class="btn btn-primary" data-toggle="collapse" data-target="#sustainability-form"><?php echo $this->translate('Ändra') ?></button>

    <div id="sustainability-form" class="collapse">
      <?php echo $this->form()->openTag($sform) ?>
      <div class="checkbox">
        <?php
        $this->formMultiCheckbox()->setSeparator('</div><div class="checkbox">');
          echo $this->formMultiCheckbox($sform->get('sustainability'));
          ?>
      </div>
      <br />
      <?php echo $this->formSubmit($submit) ?>
      <?php echo $this->form()->closeTag() ?>
    </div>
  </div>
</section>

<section class="container fund-page">
  <div class="row">
    <div class="col-md-8">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3>
            <?php echo $this->translate('Hållbara investeringar') ?>
          </h3>
        </div>
        <div class="panel-body">
          <div class="chart-container pull-left big-chart">
            <canvas class="sustainability-chart" data-percentage="<?php echo $fund->getSustainability() ?>"></canvas>
          </div>

          <?php if ($cCategoriesCount): ?>

            <p>
              <?php echo $this->translate('Hållbarheten i fonden är uträknad
              utifrån dina valda hållbarhetskategorier.
              Fonden når inte full hållbarhetsnivå då den
              investerar i företag kopplade till:') ?>
            </p>

            <ul class="sustainability-categories-list">
              <?php foreach ($cCategoriesCount as $cCat): ?>
                <li><?php echo $cCat[0]; ?></li>
              <?php endforeach; ?>
            </ul>
          <?php else: ?>
            <p>
              <?php echo $this->translate('
              Fonden har inga bolag i de kategorier du valt och har därför full
              hållbarhetsnivå!
              ') ?>
            </p>
            <?php endif; ?>

            <table class="table sustainability-grades-explained">
              <th></th>
              <th><h4><?php echo $this->translate('Hållbarhetsnivåer') ?></h4></th>
              <tr>
                <td class="chart-cell">
                  <div class="chart-container pull-left small-chart">
                    <canvas class="sustainability-chart" data-smallchart="1" data-percentage="1"></canvas>
                  </div>
                </td>
                <td>
                  <?php echo $this->translate('Hållbar fond enligt din sökning.') ?>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="chart-container pull-left small-chart">
                    <canvas class="sustainability-chart" data-smallchart="1" data-percentage=".8"></canvas>
                  </div>
                </td>
                <td>
                  <?php echo $this->translate('Fonden har ett fåtal ohållbara bolag.') ?>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="chart-container pull-left small-chart">
                    <canvas class="sustainability-chart" data-smallchart="1" data-percentage=".6"></canvas>
                  </div>
                </td>
                <td>
                  <?php echo $this->translate('Fonden har en stor del ohållbara bolag.') ?>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="chart-container pull-left small-chart">
                    <canvas class="sustainability-chart" data-smallchart="1" data-percentage=".4"></canvas>
                  </div>
                </td>
                <td>
                  <?php echo $this->translate('Fonden har en mycket stor del ohållbara bolag.') ?>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="chart-container pull-left small-chart">
                    <canvas class="sustainability-chart" data-smallchart="1" data-percentage=".2"></canvas>
                  </div>
                </td>
                <td>
                  <?php echo $this->translate('Denna fond stämmer inte in på dina hållbarhetskriterier.') ?>
                </td>
              </tr>

            </table>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading">
            <h3><?php echo $this->translate('CO<sub>2</sub>-utsläpp') ?></h3>
          </div>
          <div class="panel-body">
            <?php if ($fund->co2Coverage > 0.5):?>

              <div class="co2-meter">
                <div class="co2-meter-number">
                  <?php
                    if ($fund->co2 < 10):
                      echo number_format($fund->co2, 2, ',', ' ');
                    else:
                      echo number_format($fund->co2, 1, ',', ' ');
                    endif;
                  ?>
                </div>
                <div class="co2-meter-unit">gram CO2/kr</div>
              </div>
              <div class="co2-text">
                <p><?php echo $this->translate('Företagen i fondens gemensamma CO<sub>2</sub>-utsläpp.') ?></p>

                <?php echo $this->translate('Täckningsgrad: ') ?>
                <strong>
                <?php
                echo $this->numberFormat(
                $fund->co2Coverage,
                NumberFormatter::PERCENT,
                NumberFormatter::TYPE_DEFAULT,
                "en_US"
                );
                ?>
                </strong>
                <?php echo $this->translate(' - andel av fonden som vi har CO<sub>2</sub>-utsläppsdata på.') ?>
              </div>
            <?php else: ?>
              <?php echo $this->translate('Ej tillgängligt. <br>Vi saknar tillräckligt med underliggande data för att beräkna CO<sub>2</sub>-utsläpp på denna fond.') ?>
            <?php endif; ?>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="panel panel-default">
          <div class="panel-heading"><h3><?php echo $this->translate('Köp fonden') ?></h3></div>
          <div class="panel-body">
            <p>
              <?php echo $this->translate('Fonden finns tillgänglig att köpa på:') ?>
            </p>
            <ul>
              <?php foreach ($banks as $bank): ?>
                <li><?php echo $this->translate($bank['name']) ?></li>
              <?php endforeach; ?>
            </ul>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading"><h3>Liknande fonder</h3></div>
          <div class="panel-body">

            <table class="table table-hover">
              <thead>
                <tr>
                  <th>
                    <?php echo $this->translate('Fond') ?>
                  </th>
                  <th>
                    <?php echo $this->translate('Hållbarhet') ?>
                  </th>
                </tr>
              </thead>
              <tbody>
                <?php foreach ($funds as $fund): ?>
                  <tr>
                    <td>
                      <h4>
                      <a href="<?php echo $this->escapeHtmlAttr($this->url('funds', array('id' => $fund->id))) ?>" title="">
                        <?php echo $this->translate($fund->name) ?>
                      </a>
                      </h4>
                      <p>
                      <?php
                        if ($fund->getCo2Coverage() > 0.5) :
                          echo $this->translate('CO<sub>2</sub>-utsläpp: ') . number_format($fund->getCo2(), 2) . "gram CO<sub>2</sub>/kr";
                        else:
                          echo $this->translate('CO<sub>2</sub>-utsläpp ej tillgängligt.');
                        endif;
                      ?></p>
                    </td>

                    <td>
                      <div class="chart-container pull-left similar-chart">
                        <canvas class="sustainability-chart" data-smallchart="1" data-percentage="<?php echo $fund->getSustainability(); ?>"></canvas>
                      </div>

                    </td>
                  </tr>
                <?php endforeach; ?>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>
