box: wercker/php
no-response-timeout: 10
build:
    # The steps that will be executed on build
    steps:
      # Frontend pipeline
      - script:
          name: install node
          code: |
              echo '\n' | sudo add-apt-repository ppa:chris-lea/node.js
              sudo apt-get update
              sudo apt-get install nodejs
      - script:
          name: install npm
          code: |
              curl -L http://www.npmjs.org/install.sh -o /home/ubuntu/tmp/npm.sh
              sudo clean=y sh /home/ubuntu/tmp/npm.sh
              sudo rm -rf /home/ubuntu/tmp/
              mkdir -p /home/ubuntu/tmp/
      - npm-install
      - script:
          name: install bower
          code: sudo npm install -g bower
      - script:
          name: install bower packages
          code: bower install --config.storage.cache=$WERCKER_CACHE_DIR/wercker/bower
      - script:
          name: echo nodejs information
          code: |
              echo "node version: $(node -v)"
              echo "npm version: $(npm -v)"
      - grunt:
          tasks: less

      # Backend pipeline
      - script:
          name: install composer packages
          code: composer install --no-interaction --optimize-autoloader --no-dev
    after-steps:
        - sherzberg/slack-notify:
            subdomain: sparfabriken
            token: $SLACK_TOKEN
            channel: "#software"
            username: wercker
            icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140

deploy:
    steps:
#      Crashes with new update, try doing this in the deploy hook on openshift
#      - script:
#          name: generate doctrine proxies
#          code: vendor/bin/doctrine-module orm:generate-proxies

      - script:
          name: fix .gitignore to upload a full build to openshift.
          code: |
              pwd
              cd /pipeline/build
              ls -la
              cat .gitignore
              shopt -s globstar
              rm -r ./**/.gitignore
              echo "/node_modules" > .gitignore
              echo "/vendor" >> .gitignore
      - script:
          name: create openshift webroot symlink
          code: |
              ln -s public php
              ln -s vendor libs
      - script:
          name: Add authentication to htaccess on the staging server.
          code: |
              cat "./public/.htaccess_auth_$DEPLOY_TARGET" >> ./public/.htaccess

      - openshift-deploy
    after-steps:
        - sherzberg/slack-notify:
            subdomain: sparfabriken
            token: $SLACK_TOKEN
            channel: "#software"
            username: wercker
            icon_url: https://avatars3.githubusercontent.com/u/1695193?s=140
            
